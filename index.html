<?xml version="1.0" encoding="utf-8"?>
<html>

<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">

	<!-- I <3 Google -->
	<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
	<!-- http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/src/ -->
	<script type="text/javascript" src="markerclusterer_packed.js"></script>	

	<script type="text/javascript" src="jslider/js/jquery-1.7.1.js"></script>
	<script type="text/javascript" src="Alerts.js"></script>

	<!-- http://egorkhmelev.github.com/jslider/ -->
	<link rel="stylesheet" href="jslider/bin/jquery.slider.min.css" type="text/css">
	<script type="text/javascript" src="jslider/bin/jquery.slider.min.js"></script>

	<script type="text/javascript" src="Areas.js"></script>
	<script type="text/javascript" src="sound.js"></script>

	<style type="text/css">
		ins { text-align: center; }
		#sidebar { position: absolute; right: 10px; top: 5px; direction: rtl; margin-left: 815px; }
		#nofind { position: absolute; top: 5px; width: 95%; z-Index: 5; display: none;
			border: 1px solid black; background: #ffffaa; padding: 5px; }
		.affects_me { color: red; }
	</style>
</head>


<body>
	<div id="nofind">
	We couldn't automatically figure out your current location.<br />
	Enter your city's name in the box to hear the siren for your area.
	</div>
	<div id="map" style="width: 800px; height: 500px;"></div>
	<div style="width: 800px;">
	        <input id="time_slider" name="time_slider" type="slider" value="1353178861;1353251109" />
	</div>

	<div style="width: 800px;">
	<br /><br />
	<div style="font-size: 0.8em;">
	<p>
	Instructions: Drag sliders to change the time period shown on the map.  Zoom in and out of the map
	for more detail on locations.  Click on a single marker to see location and time.
	</p>
	<p>Note: This are the city centers, we are showing TZEVA ADOM warnings, not actual rocket impact
	sites.  This is to prevent such information being used by terrorists to help improve their aim.
	</p>
	</div>
	</div>

	<div id="sidebar">
	<p>אזעקות אחרונות:</p>
		<div id="recentAlerts"></div>
		<div style="direction: ltr;">
		<p>If your location is available, and you're in a new alert area, the area name will show in red and a tzeva adom siren will sound on your PC.  <button onclick="siren.play();">Siren Test</button></p>
		<p>Developers: see <a href="alerts.html">alerts.html</a>, <a href="docs">/docs</a> and
		<a href="test.php">test.php</a>.
		<label><input id="showtests" type="checkbox" />Show Test Alerts</label></p>
		</div>
	</div>



	<script type="text/javascript">
	var siren = preloadSound("tzeva-adom.ogg");


	// :(
	function groupAlerts() {
		var alerts=[], locs=[], time, oldtime = 0, count=0;
		for (var i=locations.length-1; i>0 && count<10; i--) {
			time = locations[i].time;
			if (time != oldtime) {
				if (locs.length > 0)
					alerts.push({ time: oldtime, locs: locs });
				locs = [];
				count++;
			}
			locs.push(locations[i]);
			oldtime = time;
		}
		return alerts;
	}

	function recentAlerts() {
		var peg = $('#recentAlerts');
		var alerts = groupAlerts();
		var area_name, time, oldtime = 0, locs;
		var p = ''; var affects_me = false;
		var area;
		for (var i=0; i < alerts.length; i++) {
			locs = alerts[i].locs;
			time = new Date(alerts[i].time*1000);
			time = pad(time.getHours()) + ':' + pad(time.getMinutes());
//				+ ' ' + pad(time.getDate()) + '.' + pad(time.getMonth());
			p += '<span class="time">'+time+'</span> - ';
			for (var j=0; j < locs.length; j++) {
				area = areas.byName(locs[j].area_name); // null on first run
				affects_me = user_loc && area && area.containsGeo(user_loc);
				p += '<span class="loc' + (affects_me ? ' affects_me' : '') + '">'
					+ locs[j].area_name + '</span>, ';
			}
			p = p.replace(/, $/, '<br>');
		}
		peg.html(p);
	}

	function pad(value) {
		return value.toString().length == 1 ? '0'+value.toString() : value;
	}

	function updateMarkerVisibility(value) {
		value = value.split(';');
		var from = value[0], to = value[1];

		for(var i=0; i < locations.length; i++) {
			//console.log(from + ' ' + locations[i].time + ' ' + to + ' '
			//	+ (locations[i].time > from && locations[i].time < to));
			locations[i].marker.setVisible(locations[i].time > from && locations[i].time < to);
		}
		markerCluster.repaint();
	}

	function scaleArray(from, to, intervals) {
		var scale = [], value, date;
		var interval = (to-from)/(intervals-1);
		for (var i=0; i<intervals; i++) {
			value = from + interval*i;
			date = new Date(value*1000);
			scale.push(
				pad(date.getHours())+':'+pad(date.getMinutes())+'<br>'+
				pad(date.getDate())+'.'+pad(date.getMonth())+'.'+date.getFullYear()
			);
		}
		return scale;
	}

	var locations = [];
	var markers = [];
	var markerCluster;
	function init(mylocations) {
		locations = mylocations;
		locations.sort(function(a,b) {
			return a.time - b.time;
		});
		//var ceasefire = Math.round(new Date("November 21, 2012 21:00:00 GMT+0200").getTime() / 1000);
		var start = Math.round(new Date("July 12, 2014 15:00:00 GMT+0200").getTime() / 1000);
		var now = Math.round(new Date().getTime() / 1000);
		//$('#time_slider').val(locations[0].time+';'+locations[locations.length-1].time);
		$('#time_slider').val(start+';'+now);

		// http://stackoverflow.com/questions/3059044/google-maps-js-api-v3-simple-multiple-marker-example
		// Awesome code from Daniel Vassallo

	        var marker, i;

		for (i = 0; i < locations.length; i++) {  
			marker = new google.maps.Marker({
				position: new google.maps.LatLng(locations[i].lat, locations[i].long)
			  	//map: map
			});

			locations[i].marker = marker;

			google.maps.event.addListener(marker, 'click', (function(marker, i) {
				  return function() {
			    infowindow.setContent(locations[i].desc);
			    infowindow.open(map, marker);
			  }
			})(marker, i));

			markers.push(marker);
		}

		markerCluster = new MarkerClusterer(map, markers, {ignoreHidden: true});

		var slider_start = locations[0].time - 3600;
		var slider_end = locations[locations.length-1].time + 3600;

		jQuery("#time_slider").slider({
			from: slider_start,
			to: slider_end,
			step: 60,
			dimension: '',
			scale: scaleArray(slider_start, slider_end, 10),
			limits: false,
			calculate: function( value ){
				var date = new Date(value*1000);
				// Wed Nov 14 2012 23:00:00 GMT+0200 (SAST)
				// Note, no guarantee locale output will look like this, but ideally strip timeone data
			return date.toString().match(/^(.* [0-9][0-9]:[0-9][0-9]):.*$/)[1];
			},
			onstatechange: function( value ) {
				updateMarkerVisibility(value);
			}	
		});

		recentAlerts();
	}

	var map = new google.maps.Map(document.getElementById('map'), {
        	zoom: 9,
	        center: new google.maps.LatLng(31.7, 34.5),
	        mapTypeId: google.maps.MapTypeId.ROADMAP
	});

        var infowindow = new google.maps.InfoWindow();

	function alerts_to_locations(alerts) {
		var locations = [];
		for (var i=0; i < alerts.length; i++)
			locations.push({ desc: alerts[i].area_name + '<br>'
				+ new Date(alerts[i].time*1000).toString(),
				lat:alerts[i].area_lat, long:alerts[i].area_long, time:alerts[i].time,
				area_name: alerts[i].area_name, time: alerts[i].time});
		return locations;
	}


	function alerts2_to_locations(data) {
		var locations = [];
		for (var i=0; i < data.areas.length; i++)
			areas.add(data.areas[i]); 
		for (var i=0; i < data.alerts.length; i++) {
			if (!$('#showtests').is(':checked') && data.alerts[i].source == "test")
				continue;
			var area = areas.byId(data.alerts[i].area_id);
			locations.push({ desc: area.name + '<br>'
				+ new Date(data.alerts[i].time*1000).toString(),
				lat:area.getLat(), long:area.getLong(), time:data.alerts[i].time,
				area_name: area.name, area_id: area.id });
		}
		return locations;
	}

	var user_loc = null;
	function geo_success(position) {
		user_loc = position;
		recentAlerts();
	}
	function geo_error() {
	}
	if (navigator.geolocation) {
		navigator.geolocation.getCurrentPosition(geo_success, geo_error);
	} else {
		geo_error('not supported');
	}

	// fetch initial data (all previous warnings)
	$.ajax({
		url: 'alerts.php?lastId=2090&nocache=' + new Date().getTime(), dataType: 'json',
		success: function(data) {
			//alerts.poll();
			init(alerts_to_locations(data));
		}
	});

	// code to poll for future alerts
	var alerts = new Alerts();
	alerts.callback(function(data) { console.log(data); } );
	alerts.callback(function(data) {
		var newlocs = alerts2_to_locations(data);
		console.log(newlocs);
		locations = locations.concat(newlocs);
		recentAlerts();

		if (user_loc)
			for (var i=0; i < data.alerts.length; i++) {
				if (!$('#showtests').is(':checked') && data.alerts[i].source == "test")
					continue;
				if (areas.byId(data.alerts[i].area_id).containsGeo(user_loc)) {
					// new alert for user's location!
					siren.play();
				}
			}
	});
	alerts.poll();

      </script>
</body>
</html>

