<html>

<head>
	<script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>

	<!-- http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markerclustererplus/src/ -->
	<script type="text/javascript" src="markerclusterer_packed.js"></script>	

	<script type="text/javascript" src="jslider/js/jquery-1.7.1.js"></script>

	<!-- http://egorkhmelev.github.com/jslider/ -->
	<link rel="stylesheet" href="jslider/bin/jquery.slider.min.css" type="text/css">
	<script type="text/javascript" src="jslider/bin/jquery.slider.min.js"></script>

	<style type="text/css">
		ins { text-align: center; }
	</style>
</head>


<body>
	<div id="map" style="width: 800px; height: 500px;"></div>
	<div style="width: 800px;">
	        <input id="time_slider" name="time_slider" type="slider" value="1353178861;1353251109" />
	</div>

	<script type="text/javascript">

	function pad(value) {
		return value.toString().length == 1 ? '0'+value.toString() : value;
	}

	function updateMarkerVisibility(value) {
		value = value.split(';');
		var from = value[0], to = value[1];

		for(var i=0; i < locations.length; i++)
			locations[i].marker.setVisible(locations[i].time > from && locations[i].time < to);
		markerCluster.repaint();
	}

	function scaleArray(from, to, intervals) {
		var scale = [], value, date;
		var interval = (to-from)/(intervals-1);
		for (var i=0; i<intervals; i++) {
			value = from + interval*i;
			date = new Date(value*1000);
			scale.push(
				pad(date.getHours())+':'+pad(date.getMinutes())+'<br>'+
				pad(date.getDate())+'.'+pad(date.getMonth())+'.'+date.getFullYear()
			);
		}
		return scale;
	}

	var locations = [];
	var markers = [];
	var markerCluster;
	function init(mylocations) {
		locations = mylocations;
		locations.sort(function(a,b) {
			return a.time - b.time;
		});
		$('#time_slider').val(locations[0].time+';'+locations[locations.length-1].time);

		// http://stackoverflow.com/questions/3059044/google-maps-js-api-v3-simple-multiple-marker-example
		// Awesome code from Daniel Vassallo

	        var marker, i;

		for (i = 0; i < locations.length; i++) {  
			marker = new google.maps.Marker({
				position: new google.maps.LatLng(locations[i].lat, locations[i].long),
			  	//map: map
			});

			locations[i].marker = marker;

			google.maps.event.addListener(marker, 'click', (function(marker, i) {
				  return function() {
			    infowindow.setContent(locations[i].desc);
			    infowindow.open(map, marker);
			  }
			})(marker, i));

			markers.push(marker);
		}

		markerCluster = new MarkerClusterer(map, markers, {ignoreHidden: true});

		var slider_start = locations[0].time - 3600;
		var slider_end = locations[locations.length-1].time + 3600;

		jQuery("#time_slider").slider({
			from: slider_start,
			to: slider_end,
			step: 60,
			dimension: '',
			scale: scaleArray(slider_start, slider_end, 10),
			limits: false,
			calculate: function( value ){
				var date = new Date(value*1000);
				// Wed Nov 14 2012 23:00:00 GMT+0200 (SAST)
				// Note, no guarantee locale output will look like this, but ideally strip timeone data
			return date.toString().match(/^(.* [0-9][0-9]:[0-9][0-9]):.*$/)[1];
			},
			onstatechange: function( value ) {
				updateMarkerVisibility(value);
			}	
		});
	}

	var map = new google.maps.Map(document.getElementById('map'), {
        	zoom: 10,
	        center: new google.maps.LatLng(31.5, 34.5),
	        mapTypeId: google.maps.MapTypeId.ROADMAP
	});

        var infowindow = new google.maps.InfoWindow();


	function sveder_to_locations(sveder) {
		var locations = [];
		for (var i=0; i < sveder.length; i++)
			locations.push({ desc: sveder[i].area_name_english + '<br>'
				+ new Date(sveder[i].when).toString(),
				lat:sveder[i].area_center_lat, long:sveder[i].area_center_long, time:sveder[i].when});
		return locations;
	}

	// https://github.com/Sveder/red_color_map, http://redalert.sveder.com/

	// http://redalert.sveder.com/api/latest
	var sveder = [{"when": 1353251109, "area_center_long": 34.604946, "area_center_lat": 31.676731, "area_name_english": "Hof Ashkelon"}, {"when": 1353248266, "area_center_long": 34.604946, "area_center_lat": 31.676731, "area_name_english": "Hof Ashkelon"}, {"when": 1353246352, "area_center_long": 34.604946, "area_center_lat": 31.676731, "area_name_english": "Hof Ashkelon"}, {"when": 1353246314, "area_center_long": 34.604946, "area_center_lat": 31.676731, "area_name_english": "Hof Ashkelon"}, {"when": 1353189590, "area_center_long": 34.630337, "area_center_lat": 31.507726, "area_name_english": "Shaar Hanegev"}, {"when": 1353185369, "area_center_long": 34.431501, "area_center_lat": 31.303121, "area_name_english": "Eshkol"}, {"when": 1353181336, "area_center_long": 34.591612815856934, "area_center_lat": 31.433606583901508, "area_name_english": "Sdot Negev"}, {"when": 1353178989, "area_center_long": 34.431501, "area_center_lat": 31.303121, "area_name_english": "Eshkol"}, {"when": 1353178904, "area_center_long": 34.622824, "area_center_lat": 31.311337, "area_name_english": "Ofakim"}, {"when": 1353178861, "area_center_long": 34.591612815856934, "area_center_lat": 31.433606583901508, "area_name_english": "Sdot Negev"}];

	init(sveder_to_locations(sveder));
/*
	$.ajax({
		url: 'http://redalert.sveder.com/api/latest',
		dataType: 'html', // cross-site
		success: function(data) {
			console.log(data);
		}
	});
*/
      </script>
</body>
</html>

